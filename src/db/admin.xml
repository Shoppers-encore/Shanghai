<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Admin">
	<!-- admin login from jk_user -->
	<select id="getUser" parameterType="String" resultType="databean.UserDataBean">
		SELECT * FROM jk_user WHERE id=#{id}
	</select>
	<select id="getUserListCount" resultType="int">
		SELECT count(*) FROM jk_user
	</select>
	<select id="getNameuserlist" parameterType="String" resultType="databean.UserDataBean">
		SELECT * FROM jk_user WHERE name=#{name}
	</select>
	<select id="getAlluserlist" parameterType="java.util.Map" resultType="databean.UserDataBean">
		SELECT id, password, name, birthday, tel, email, gender, userLevel, height, weight, address, addressDetail, zipcode, r FROM(
		SELECT id, password, name, birthday, tel, email, gender, userLevel, height, weight, address, addressDetail, zipcode, rownum r FROM 
		(SELECT * FROM jk_user ORDER BY userLevel desc, id asc)) WHERE r &gt;= TO_NUMBER(#{start}) AND r &lt;= TO_NUMBER(#{end})
	</select>
	<select id="getSearchCount" parameterType="String" resultType="int">
		<!-- SELECT count(ref) FROM jk_product WHERE productCode =TO_CHAR(ref) AND productName LIKE '%'||#{searchWord}||'%' -->
		SELECT count(*) FROM jk_product WHERE ref IN (SELECT MAX(ref) FROM jk_product
		WHERE productName LIKE '%'||#{searchWord}||'%' GROUP BY ref) AND productCode=TO_CHAR(ref)
	</select>
	<select id="getOrderCount" resultType="int">
	 	 SELECT count(*) FROM jk_orderList
	</select>
	<select id="selectOrderList" parameterType="java.util.Map" resultType="databean.OrderListDataBean">
		  SELECT tmp.*, r FROM (SELECT list.*, rownum r FROM (SELECT * FROM jk_orderList ORDER BY ordercode desc) list ORDER BY ordercode  desc) tmp WHERE r &gt;=TO_NUMBER(#{start}) AND r &lt;=TO_NUMBER(#{end})
	</select>
	<select id="userCount" parameterType="String" resultType="int">
	 	 SELECT count(orderCode) FROM jk_orderList WHERE id=#{id}
	</select>
	<select id="getOrderList" parameterType="java.util.Map" resultType="databean.OrderListDataBean">
		SELECT orderCode, productCode, id, orderZipcode, orderAddress1, orderAddress2, orderDate, orderStatus, orderQuantity, orderPrice, r FROM(
		SELECT orderCode, productCode, id, orderZipcode, orderAddress1, orderAddress2, orderDate, orderStatus, orderQuantity, orderPrice, rownum r FROM 
		(SELECT * FROM jk_orderList ORDER BY orderCode desc)) WHERE r &gt;= TO_NUMBER(#{start}) AND r &lt;= TO_NUMBER(#{end})
	</select>
 	<select id="getOrder" parameterType="String" resultType="databean.OrderListDataBean">
		SELECT * FROM jk_orderList WHERE id=#{id}
	</select>
	<select id="getAllCount" resultType="int">
	 	 SELECT count(*) FROM jk_orderList
	 </select>
	 <select id="selectAllOrderList" parameterType="java.util.Map" resultType="databean.OrderListDataBean">
		  SELECT tmp.*, r FROM (SELECT list.*, rownum r FROM (SELECT * FROM jk_orderList ORDER BY orderCode desc) list ORDER BY orderCode desc) tmp WHERE r &gt;=TO_NUMBER(#{start}) AND r &lt;=TO_NUMBER(#{end})
	 </select>
	 <select id="selectUserOrderList" parameterType="java.util.Map" resultType="databean.OrderListDataBean">
	 	 SELECT tmp.*, r FROM (SELECT list.*, rownum r FROM (SELECT * FROM jk_orderList WHERE id=#{id} ORDER BY orderCode desc) list ) tmp WHERE r &gt;=TO_NUMBER(#{start}) AND r &lt;=TO_NUMBER(#{end})
	 </select>
	 <select id="getProdCount" resultType="int">
	 	 SELECT count(*) FROM jk_product
	</select>
	<select id="getProdList" parameterType="java.util.Map" resultType="databean.ProductDataBean">
	 	SELECT ref, productCode, productName, productContent, discount, productPrice, productRegDate, productQuantity, thumbnail, productCategory, r FROM(
		SELECT ref, productCode, productName, productContent, discount, productPrice, productRegDate, productQuantity, thumbnail, productCategory, rownum r FROM 
		(SELECT * FROM jk_product WHERE productCode != TO_CHAR(ref) ORDER BY ref desc)) WHERE r &gt;= TO_NUMBER(#{start}) AND r &lt;= TO_NUMBER(#{end})
	</select>
	<select id="getRef" resultType="int">
		SELECT max(ref) FROM jk_product
	</select>
	<insert id="input" parameterType="databean.ProductDataBean">
	INSERT INTO jk_product (ref, productCode, productName, productContent, discount, productPrice, productRegDate, productQuantity, productCategory, thumbnail) 
	VALUES (#{ref}, #{productCode}, #{productName}, #{productContent}, #{discount, jdbcType=INTEGER}, #{productPrice}, #{productRegDate}, #{productQuantity}, #{productCategory}, #{thumbnail})
	</insert>
	<select id="maxImg" resultType="int">
		SELECT max(imageNo) FROM jk_imageInfo
	</select>
	<insert id="insertImg" parameterType="databean.ImageInfoDataBean">
		INSERT INTO jk_imageInfo VALUES (#{imageNo}, #{ref}, #{imageAddress})
	</insert>
	<select id="getTags" resultType="databean.TagDataBean">
		SELECT * FROM jk_tag
	</select>
	<insert id="insertTag" parameterType="String">
		INSERT INTO jk_tag VALUES (tagIdSeq.NEXTVAL, #{newTag})
	</insert>
	<select id="maxTag" resultType="int">
		SELECT max(tagId) FROM jk_ProductTag
	</select>
	<select id="getImgAddress" parameterType="int" resultType="String">
		 SELECT imageAddress FROM jk_imageInfo WHERE ref=#{ref} AND MOD(imageNo, 2) = 1
	</select>
	<delete id="deleteTag" parameterType="int">
		DELETE FROM jk_tag WHERE tagId = #{tagId}
	</delete>
	<insert id="insertProdTag" parameterType="databean.ProductTagDataBean">
		INSERT INTO jk_ProductTag VALUES (#{ref}, #{tagId})
	</insert>
	<select id="getProdDetail" parameterType="int" resultType="databean.ProductDataBean">
		SELECT * FROM jk_product WHERE ref=#{ref}
	</select>
	<select id="getImgDetail" parameterType="int" resultType="databean.ImageInfoDataBean">
		SELECT * FROM jk_imageInfo WHERE ref=#{ref}
	</select>
	<delete id="deleteImg" parameterType="int">
		DELETE FROM jk_imageInfo WHERE ref=#{ref}
	</delete>
	<delete id="deleteProd" parameterType="int">
		DELETE FROM jk_product WHERE ref=#{ref}
	</delete>
	<update id="admModify" parameterType="databean.UserDataBean">
		UPDATE jk_user SET password=#{password}, name=#{name}, tel=#{tel}, email=#{email} WHERE id=#{id} 
	</update>
	<update id="changeStatus" parameterType="java.util.Map">
	 	UPDATE jk_orderList SET orderStatus=orderStatus+1 WHERE id=#{id} AND orderCode=TO_NUMBER(#{orderCode})
	 </update>
	 <select id="getRvList" parameterType="java.util.Map" resultType="databean.ReviewDataBean">
		SELECT tmp.*, r FROM (SELECT list.*, rownum r FROM (SELECT * FROM jk_review ORDER BY reviewNo desc) list ORDER BY reviewNo desc) tmp WHERE r &gt;=TO_NUMBER(#{start}) AND r &lt;=TO_NUMBER(#{end})
	</select>
	<select id="getProdName" parameterType="String" resultType="String">
		SELECT productName from jk_product WHERE productCode=#{productCode}
	</select>
	<delete id="reviewDelete" parameterType="int">
		DELETE FROM jk_review WHERE reviewNo=#{reviewNo}
	</delete>
	<select id="getProductTagId" parameterType="int" resultType="int">
		SELECT tagId FROM jk_productTag WHERE ref=#{ref}
	</select>
	<update id="changeQuantity" parameterType="databean.ProductDataBean">
		UPDATE jk_product SET productQuantity=${productQuantity} WHERE productCode=#{productCode}
	</update>
	<select id="getProductCodeList" parameterType="int" resultType="String">
		SELECT productCode FROM jk_product WHERE ref=#{ref}
	</select>
	<update id="modifyProduct" parameterType="databean.ProductDataBean">
		MERGE INTO jk_product USING DUAL ON (productCode = #{productCode}) WHEN MATCHED THEN UPDATE SET productContent=#{productContent}, discount=#{discount, jdbcType=INTEGER},  productPrice=#{productPrice}, productCategory=#{productCategory} WHERE productCode=#{productCode}
		WHEN NOT MATCHED THEN INSERT (ref, productCode, productCategory, productName, productContent, discount, productPrice, productRegDate, productQuantity, thumbnail) 
		VALUES (#{ref},#{productCode},#{productCategory},#{productName},#{productContent},#{discount, jdbcType=INTEGER},#{productPrice},sysdate ,#{productQuantity},'abc.jpg')
	</update>
	<delete id="deleteProduct" parameterType="String">
		DELETE FROM jk_product WHERE productCode=#{product}
	</delete>
	<select id="getProdQuantity" parameterType="String" resultType="int">
		SELECT productQuantity FROM jk_product WHERE productCode=#{productCode}
	</select>
	<!-- chatData -->
	<select id="getChatList" resultType="databean.ChatDataBean">
		SELECT * FROM jk_chat
		WHERE chatdate IN (select MAX(chatDate) from jk_chat group by sender) ORDER BY chatdate desc
	</select>
	<select id="getChatListCount" resultType="int">
		SELECT count(*) FROM jk_chat
	</select>
	<select id="getRefNo" parameterType="String" resultType="int">
		SELECT ref FROM jk_product WHERE productCode=#{productCode}
	</select>
	<select id="prodFromOrder" parameterType="int" resultType="int">
		SELECT count(productCode) FROM jk_orderList WHERE orderCode=#{orderCode}
	</select>
	<select id="getOrderDetail" parameterType="int" resultType="databean.OrderListDataBean">
		SELECT * FROM jk_orderList WHERE orderCode=#{orderCode}
	</select>
 	<select id="getProductSearchList" parameterType="java.util.Map" resultType="databean.ProductDataBean">
		<!-- SELECT * FROM jk_product WHERE productName LIKE '%'||#{searchWord}||'%' AND productCode=to_char(ref) -->
		SELECT tmp.*, r FROM (SELECT tmp2.*, rownum r FROM (SELECT * FROM jk_product WHERE ref in 
		(SELECT MAX(ref) FROM jk_product WHERE productName LIKE '%'||#{searchWord}||'%'
		 GROUP BY ref) AND productCode=TO_CHAR(ref)) tmp2) tmp WHERE r &gt;= TO_NUMBER(#{start}) AND r &lt;= TO_NUMBER(#{end})
	</select> 	
</mapper>